server {
    listen       80;
    server_name  utm.local;
    root   /var/www/html/app/webroot;
    index index.php;
    expires epoch;
    
    gzip            on;
    gzip_min_length 1000;
    gzip_proxied    expired no-cache no-store private auth;
    gzip_types      text/plain application/xml application/x-javascript application/javascript text/css image/jpeg image/png;

    #charset koi8-r;
    access_log  /var/log/nginx/utm.access.log;

    location / {
        allow all;

	proxy_read_timeout 600;
	client_max_body_size 16M;
	#auth_basic "Restricted Content";
        #auth_basic_user_file /etc/nginx/.htpasswd;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options nosniff;
	    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' *.yandex.ru *.yamoney.ru https://yoomoney.ru *.google.com *.fontawesome.com *.gstatic.com *.google-analytics.com *.googleapis.com mc.yandex.ru *.googletagmanager.com *.jivosite.com *.bootstrapcdn.com; style-src 'self' 'unsafe-inline' *.googleapis.com *.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.google.com *.gstatic.com  mc.yandex.ru *.googletagmanager.com *.google-analytics.com *.jivosite.com api-maps.yandex.ru *.maps.yandex.net https://unpkg.com *.bootstrapcdn.com *.facebook.net; connect-src 'self' *.yandex.ru *.google-analytics.com *.jivosite.com wss://*.jivosite.com *.facebook.com;  img-src 'self' 'unsafe-inline' * data:; worker-src 'self' 'unsafe-inline' blob: data:";

	    try_files $uri $uri/ /index.php?$args;
    }
    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ \.php$ {
        root           /var/www/html/app/webroot;
        client_max_body_size 16M;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_hide_header X-Powered-By;
        fastcgi_hide_header X-Powered-By;
	#more_set_headers 'Server: my-server';
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options nosniff;
        add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' *.yandex.ru *.yamoney.ru *.google.com *.fontawesome.com *.gstatic.com *.google-analytics.com *.googleapis.com mc.yandex.ru *.googletagmanager.com *.jivosite.com *.bootstrapcdn.com *.youtube.com googleads.g.doubleclick.net; style-src 'self' 'unsafe-inline' *.googleapis.com *.gstatic.com *.jivosite.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.google.com *.gstatic.com mc.yandex.ru *.yandex.net *.googletagmanager.com *.google-analytics.com *.jivosite.com api-maps.yandex.ru yastatic.net https://unpkg.com *.bootstrapcdn.com *.facebook.net https://cdn.jsdelivr.net https://js.puter.com/v2/; connect-src 'self' *.cashbackforce.ru *.yandex.ru *.google-analytics.com *.jivosite.com wss://*.jivosite.com *.facebook.com https://js.puter.com/v2/ https://api.puter.com/ wss://api.puter.com data: blob:; img-src 'self' 'unsafe-inline' * data:; worker-src 'self' 'unsafe-inline' blob: data: https://cdn.jsdelivr.net;";
# 	include snippets/fastcgi-php.conf;
    location ~ \.php$ {
        fastcgi_pass php:9000;  # Имя сервиса PHP из docker-compose
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
    fastcgi_pass unix:/run/php/php5.6-fpm.sock;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
	#fastcgi_max_temp_file_size 0;
	fastcgi_buffer_size 1280k;
        fastcgi_buffers 2560 4k;
        fastcgi_busy_buffers_size 2560k;
        fastcgi_temp_file_write_size 2560k;
    }

    location ~* ^.+\.(js|css|png|jpeg|jpg|svg|bmp|gif)$ {
	    expires max;

	    root	/var/www/html/webroot;

        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options nosniff;
	    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' *.yandex.ru *.yamoney.ru *.google.com *.fontawesome.com *.gstatic.com *.google-analytics.com *.googleapis.com mc.yandex.ru *.googletagmanager.com *.jivosite.com *.bootstrapcdn.com; style-src 'self' 'unsafe-inline' *.googleapis.com *.gstatic.com *.jivosite.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' *.google.com *.gstatic.com  mc.yandex.ru yastatic.net *.googletagmanager.com *.google-analytics.com *.jivosite.com api-maps.yandex.ru https://unpkg.com *.bootstrapcdn.com; connect-src 'self' *.yandex.ru *.google-analytics.com *.jivosite.com wss://*.jivosite.com;  img-src 'self' 'unsafe-inline' * data:; worker-src 'self' 'unsafe-inline' blob: data:";
    }

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    location ~ /\.ht {
        deny  all;
    }
}
